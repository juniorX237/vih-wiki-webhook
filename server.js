const express = require('express');
const axios = require('axios');
const { SummarizerManager } = require('node-summarizer');
const app = express();

app.use(express.json());

// Configuration
const PORT = process.env.PORT || 3000;
const WIKIPEDIA_API = 'https://fr.wikipedia.org/w/api.php';
const DEFAULT_RESPONSE = "Je n'ai pas trouv√© de r√©ponse pr√©cise. Voici les bases sur le VIH :\n\n- Transmission : rapports non prot√©g√©s, sang contamin√©\n- Traitement : ARV efficaces\n- Pr√©vention : pr√©servatifs, d√©pistage";

// Base de connaissances enrichie
const KNOWLEDGE_BASE = {
  vih: [
    {
      keywords: ['sympt√¥me', 'symptomes', 'signes'],
      response: 'ü©∫ Tu te poses des questions sur les sympt√¥mes ? La plupart des gens n‚Äôont aucun signe au d√©but. Mais parfois, on peut avoir de la fi√®vre, de la fatigue, ou des ganglions gonfl√©s.'
    },
    {
      keywords: ['traitement', 'soigner', 'gu√©rir'],
      response: 'üíä Bonne nouvelle : il existe des traitements tr√®s efficaces ! Les ARV permettent de vivre normalement, d‚Äôavoir une famille, et de rester en bonne sant√©. Plus t√¥t on commence, mieux c‚Äôest.'
    },
    {
      keywords: ['transmission', 'transmet', 'contamination'],
      response: 'üîÅ Le VIH se transmet par : relations sexuelles sans pr√©servatif, sang contamin√©, ou de la m√®re √† l‚Äôenfant. Il ne se transmet pas par les c√¢lins, les moustiques ou en partageant la nourriture.'
    },
    {
      keywords: ['d√©pistage', 'test', 'diagnostic'],
      response: 'üß™ Tu peux faire un test de d√©pistage gratuitement dans un h√¥pital public ou centre de sant√©. C‚Äôest rapide, confidentiel et √ßa sauve des vies. Fais-le m√™me sans sympt√¥mes.'
    },
    {
      keywords: ['pr√©vention', 'pr√©servatif', 'prot√©ger', '√©viter'],
      response: 'üõ° Pour √©viter le VIH : utilise toujours un pr√©servatif, fais-toi d√©pister r√©guli√®rement, et informe-toi sur la PrEP (un traitement pr√©ventif). Tu as le droit de te prot√©ger.'
    },
    {
      keywords: ['meurent', 'mort', 'd√©c√®s'],
      response: 'üìä Environ 630 000 personnes sont mortes du VIH en 2022. Mais ce nombre baisse gr√¢ce aux tests et aux traitements. Se faire d√©pister √† temps sauve des vies!'
    },
    {
      keywords: ['premier pays', 'origine', 'apparu'],
      response: 'üåç Le VIH serait apparu en Afrique centrale (notamment au Cameroun et RDC), transmis √† l\'homme par des singes. Il s\'est ensuite r√©pandu √† travers le monde.'
    },
    {
      keywords: ['qui a d√©couvert', 'd√©couvreur', 'd√©couverte vih'],
      response: 'üî¨ Le VIH a √©t√© d√©couvert en 1983 par l\'√©quipe de Luc Montagnier et Fran√ßoise Barr√©-Sinoussi √† l\'Institut Pasteur, ce qui leur a valu le Prix Nobel de M√©decine en 2008.'
    },
    {
      keywords: ['quelle ann√©e', 'date d√©couverte', 'ann√©e d√©couverte'],
      response: 'üìÖ Le VIH a √©t√© d√©couvert en 1983 par des chercheurs fran√ßais de l\'Institut Pasteur.'
    },
    {
      keywords: [
        'pays avec le plus grand taux',
        'pays plus touch√©s',
        'taux contamination',
        'pays plus contamin√©s',
        'pr√©valence',
        '√©pid√©mie dans le monde'
      ],
      response: 'üåç Les pays avec le plus grand taux de contamination au VIH sont en Afrique australe : Eswatini, Lesotho, Botswana, Afrique du Sud et Zimbabwe. Dans ces pays, plus de 20% des adultes vivent avec le VIH. L\'Afrique subsaharienne reste la r√©gion la plus touch√©e au monde.'
    },
    {
      keywords: ['statistiques', 'taux', 'nombre de cas', 'combien de personnes', 'pourcentage'],
      response: 'üìä En 2023, environ 39 millions de personnes vivent avec le VIH dans le monde. Plus des deux tiers des personnes concern√©es r√©sident en Afrique subsaharienne.'
    },
    {
      keywords: [
        'vivre avec le vih',
        'peux je vivre avec le vih',
        'peut-on vivre avec le vih',
        'survivre au vih',
        'esp√©rance de vie vih',
        'rester en vie avec le vih'
      ],
      response: 'üòä Oui, il est tout √† fait possible de vivre longtemps et en bonne sant√© avec le VIH‚ÄØ! Gr√¢ce aux traitements actuels (ARV), les personnes vivant avec le VIH peuvent avoir une vie normale, travailler, fonder une famille et r√©aliser leurs projets. Le plus important est de suivre son traitement et de faire un suivi m√©dical r√©gulier.'
    },
    {
      keywords: ['salut', 'bonjour', 'coucou', 'hello'],
      response: 'üëã Bonjour ! Je suis un assistant sp√©cialis√© sur le VIH et la CSU. Posez-moi vos questions comme : "Comment se transmet le VIH ?" ou "Quels sont les sympt√¥mes ?"'
    },
    {
      keywords: ['√ßa va', 'comment vas-tu', 'tu vas bien'],
      response: 'ü§ñ Je suis un robot, donc toujours en forme ! Merci de demander üòä Comment puis-je vous aider sur le VIH ou la CSU aujourd\'hui ?'
    }
  ],
  csu: [
    {
      keywords: ['csu', 'couverture sant√©', 'sant√© universelle'],
      response: 'üìò La CSU permet aux Camerounais d\'acc√©der √† des soins √† faible co√ªt. Pour b√©n√©ficier :\n1. Rendez-vous dans un centre de sant√© agr√©√©\n2. Munissez-vous de votre CNI\n3. Demandez les informations √† l\'accueil'
    }
  ]
};

// Dictionnaire de simplification des termes m√©dicaux
const SIMPLIFICATION_MAP = {
  "immunod√©ficience": "affaiblissement des d√©fenses immunitaires",
  "syst√®me immunitaire": "d√©fenses naturelles du corps",
  "lymphocytes": "cellules de d√©fense",
  "antir√©troviraux": "m√©dicaments contre le VIH",
  "s√©ropositif": "porteur du VIH",
  "√©pid√©miologie": "√©tude des maladies",
  "pathog√®ne": "microbe dangereux",
  "r√©trovirus": "virus particulier",
  "contamination": "transmission",
  "asymptomatique": "sans sympt√¥mes",
  "opportuniste": "qui profite de la faiblesse",
  "pand√©mie": "maladie mondiale",
  "pr√©valence": "nombre de cas",
  "transmission": "contagion",
  "diagnostic": "d√©pistage",
  "virologie": "√©tude des virus",
  "s√©rologique": "par prise de sang"
};

// Fonctions utilitaires
const cleanText = (text) => 
  text.replace(/&nbsp;|\[\s*\d+\s*\]|\[[a-z]\]/gi, ' ')
     .replace(/\s+/g, ' ')
     .trim();

// Simplifie le texte m√©dical pour le grand public
function simplifyMedicalText(text) {
  let simplified = text;
  for (const [term, replacement] of Object.entries(SIMPLIFICATION_MAP)) {
    const regex = new RegExp(`\\b${term}\\b`, 'gi');
    simplified = simplified.replace(regex, replacement);
  }
  return simplified;
}

// Formate le texte pour Dialogflow (listes, paragraphes)
function formatResponse(text) {
  // D√©tecte les listes naturelles dans le texte
  const listRegex = /(?:-|‚Ä¢|\d+\.)\s*(.+?)(?=\n|$)/g;
  let formatted = text;
  
  // Remplace les listes d√©tect√©es par un format plus clair
  formatted = formatted.replace(listRegex, '- $1\n');
  
  // Ajoute des sauts de ligne apr√®s les points
  formatted = formatted.replace(/\.\s+/g, '.\n\n');
  
  // Limite la longueur des paragraphes
  return formatted.substring(0, 1500);
}

async function fetchWikipediaData(params) {
  try {
    const { data } = await axios.get(WIKIPEDIA_API, { 
      params: { ...params, format: 'json' },
      timeout: 5000
    });
    return data;
  } catch (error) {
    console.error('Erreur Wikipedia API:', error.message);
    return null;
  }
}

async function getWikiResponse(question) {
  // 1. Recherche de page
  const searchData = await fetchWikipediaData({
    action: 'query',
    list: 'search',
    srsearch: `VIH ${question}`,
    srlimit: 1
  });
  
  const pageId = searchData?.query?.search?.[0]?.pageid;
  if (!pageId) return null;

  // 2. R√©cup√©ration des sections
  const sectionsData = await fetchWikipediaData({
    action: 'parse',
    pageid: pageId,
    prop: 'sections'
  });

  const sections = sectionsData?.parse?.sections || [];
  
  // 3. S√©lection de section pertinente
  const relevantSection = sections.find(section => 
    question.split(' ').some(word => 
      section.line.toLowerCase().includes(word.toLowerCase())
    )) || sections[0];

  // 4. R√©cup√©ration du contenu
  const contentData = await fetchWikipediaData({
    action: 'parse',
    pageid: pageId,
    prop: 'text',
    section: relevantSection?.index
  });

  const html = contentData?.parse?.text['*'];
  if (!html) return null;
  
  // Conversion HTML en texte brut
  const rawText = html.replace(/<[^>]+>/g, ' ')
                     .replace(/\s+/g, ' ')
                     .trim();
  
  // Nettoyage et simplification
  return simplifyMedicalText(cleanText(rawText));
}

async function generateSummary(text) {
  try {
    if (!text || text.length < 100) return text;
    
    // Cr√©e un r√©sum√© avec la biblioth√®que
    const summarizer = new SummarizerManager(text, 3);
    const { summary } = await summarizer.getSummaryByRank();
    
    // Simplification suppl√©mentaire
    return simplifyMedicalText(summary);
  } catch (error) {
    console.error('Erreur de r√©sum√©:', error);
    return text.substring(0, 500) + '...';
  }
}

// Gestion des requ√™tes
app.post('/webhook', async (req, res) => {
  const query = req.body.queryResult?.queryText?.toLowerCase() || '';
  
  // 1. V√©rification du sujet
  if (!query.match(/\b(vih|sida|csu|sant√© universelle)\b/i)) {
    return res.json({
      fulfillmentText: "üîç Je suis sp√©cialis√© sur le VIH et la CSU. Posez-moi des questions comme :\n\"Comment se transmet le VIH ?\"\n\"Comment b√©n√©ficier de la CSU ?\""
    });
  }

  // 2. R√©ponses pr√©d√©finies
  const allResponses = [...KNOWLEDGE_BASE.vih, ...KNOWLEDGE_BASE.csu];
  const matchedResponse = allResponses.find(item => 
    item.keywords.some(keyword => query.includes(keyword))
  );

  if (matchedResponse) {
    return res.json({ fulfillmentText: matchedResponse.response });
  }

  // 3. Recherche Wikipedia
  try {
    const wikiText = await getWikiResponse(query);
    if (wikiText) {
      const summary = await generateSummary(wikiText);
      const formattedSummary = formatResponse(summary);
      
      return res.json({
        fulfillmentText: `üìö Voici ce que j'ai trouv√© :\n\n${formattedSummary}\n\nüí° Pour un diagnostic pr√©cis, consultez un professionnel de sant√©.`
      });
    }
  } catch (error) {
    console.error('Erreur Wikipedia:', error);
  }

  // 4. R√©ponse par d√©faut
  return res.json({ fulfillmentText: DEFAULT_RESPONSE });
});

// D√©marrer le serveur
app.listen(PORT, () => 
  console.log(`‚úÖ Serveur en √©coute sur le port ${PORT}`)
);
